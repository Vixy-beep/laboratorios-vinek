<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jorise Dashboard - Security Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f7fafc;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar h1 {
            font-size: 24px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            color: #718096;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .stat-card.credits .stat-value {
            color: #667eea;
        }
        
        .stat-card.plan .stat-value {
            color: #48bb78;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .panel h2 {
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #1a202c;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-upgrade {
            background: #48bb78;
            margin-top: 15px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .alert.error {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .alert.warning {
            background: #feebc8;
            color: #7c2d12;
        }
        
        .result-box {
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            display: none;
        }
        
        .threat-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .threat-badge.clean {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .threat-badge.suspicious {
            background: #feebc8;
            color: #7c2d12;
        }
        
        .threat-badge.malicious {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-info {
            flex: 1;
        }
        
        .history-info h4 {
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .history-info p {
            color: #718096;
            font-size: 13px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #718096;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üõ°Ô∏è Jorise Security Dashboard</h1>
        <div class="user-info">
            <span id="user-email"></span>
            <button onclick="logout()" style="padding: 8px 20px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 5px; cursor: pointer;">Salir</button>
        </div>
    </div>
    
    <div class="container">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card credits">
                <h3>Cr√©ditos Disponibles</h3>
                <div class="stat-value" id="credits-remaining">-</div>
                <small style="color: #718096;" id="credits-info">Cargando...</small>
            </div>
            
            <div class="stat-card plan">
                <h3>Plan Actual</h3>
                <div class="stat-value" id="current-plan">-</div>
                <small style="color: #718096;" id="plan-info">Cargando...</small>
            </div>
            
            <div class="stat-card">
                <h3>An√°lisis Realizados</h3>
                <div class="stat-value" id="total-analyses">-</div>
                <small style="color: #718096;">Este mes</small>
            </div>
            
            <div class="stat-card">
                <h3>Amenazas Detectadas</h3>
                <div class="stat-value" id="threats-found">-</div>
                <small style="color: #718096;">Total</small>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Analysis Panel -->
            <div class="panel">
                <h2><i class="fas fa-search"></i> Nuevo An√°lisis</h2>
                
                <div id="analysis-alert" class="alert"></div>
                
                <form id="analysis-form" onsubmit="performAnalysis(event)">
                    <div class="form-group">
                        <label>Tipo de An√°lisis</label>
                        <select id="analysis-type" required>
                            <option value="file">An√°lisis de Archivo</option>
                            <option value="url">An√°lisis de URL</option>
                            <option value="network">An√°lisis de Red</option>
                            <option value="sandbox">Sandbox Completo</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="file-input-group">
                        <label>Nombre del Archivo</label>
                        <input type="text" id="file-name" placeholder="ejemplo.exe">
                    </div>
                    
                    <div class="form-group" id="url-input-group" style="display: none;">
                        <label>URL a Analizar</label>
                        <input type="url" id="url-input" placeholder="https://ejemplo.com">
                    </div>
                    
                    <button type="submit" class="btn-primary" id="analyze-btn">
                        <i class="fas fa-shield-alt"></i> Analizar Ahora
                    </button>
                    
                    <button type="button" class="btn-primary btn-upgrade" onclick="window.location.href='jorise-pricing.html'">
                        <i class="fas fa-arrow-up"></i> Actualizar Plan
                    </button>
                </form>
                
                <!-- Result Box -->
                <div class="result-box" id="result-box">
                    <h3 style="margin-bottom: 15px;">Resultado del An√°lisis</h3>
                    <div id="result-content"></div>
                </div>
            </div>
            
            <!-- History Panel -->
            <div class="panel">
                <h2><i class="fas fa-history"></i> Historial de An√°lisis</h2>
                <div id="history-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando historial...</p>
                    </div>
                </div>
            </div>
            
            <!-- Gr√°ficos -->
            <div class="panel" style="grid-column: 1 / -1;">
                <h2><i class="fas fa-chart-bar"></i> Estad√≠sticas y Gr√°ficos</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-top: 20px;">
                    <!-- Gr√°fico de Amenazas -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">
                            <i class="fas fa-pie-chart"></i> Distribuci√≥n de Amenazas
                        </h3>
                        <canvas id="threatChart"></canvas>
                    </div>
                    
                    <!-- Gr√°fico de An√°lisis por Tiempo -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">
                            <i class="fas fa-chart-line"></i> An√°lisis Recientes
                        </h3>
                        <canvas id="analysisChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://vineksec.online/jorise-api.php';
        
        // Obtener email de URL o localStorage
        const urlParams = new URLSearchParams(window.location.search);
        let userEmail = urlParams.get('email') || localStorage.getItem('jorise_user_email');
        
        console.log('Dashboard cargando con email:', userEmail);
        console.log('URL params:', window.location.search);
        
        // Redirect si no hay email
        if (!userEmail) {
            console.error('No se encontr√≥ email, redirigiendo a pricing...');
            alert('No se encontr√≥ informaci√≥n de usuario. Por favor inicia sesi√≥n nuevamente.');
            window.location.href = 'jorise-pricing.html';
            throw new Error('No user email');
        }
        
        // Guardar email en localStorage para futuras visitas
        localStorage.setItem('jorise_user_email', userEmail);
        
        document.getElementById('user-email').textContent = userEmail;
        
        // Cambiar campos seg√∫n tipo de an√°lisis
        document.getElementById('analysis-type').addEventListener('change', (e) => {
            const fileGroup = document.getElementById('file-input-group');
            const urlGroup = document.getElementById('url-input-group');
            
            if (e.target.value === 'url') {
                fileGroup.style.display = 'none';
                urlGroup.style.display = 'block';
                document.getElementById('file-name').removeAttribute('required');
                document.getElementById('url-input').setAttribute('required', 'required');
            } else {
                fileGroup.style.display = 'block';
                urlGroup.style.display = 'none';
                document.getElementById('file-name').setAttribute('required', 'required');
                document.getElementById('url-input').removeAttribute('required');
            }
        });
        
        // Cargar datos al iniciar
        async function loadDashboard() {
            await checkCredits();
            await loadHistory();
            await loadStats();
        }
        
        async function checkCredits() {
            try {
                console.log('Verificando cr√©ditos para:', userEmail);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'check_credits', email: userEmail })
                });
                
                const data = await response.json();
                console.log('Datos de cr√©ditos:', data);
                
                if (data.success) {
                    const remaining = data.credits_remaining;
                    const used = data.credits_used;
                    const limit = data.credits_limit;
                    const plan = data.plan || 'Free';
                    
                    document.getElementById('credits-remaining').textContent = remaining;
                    document.getElementById('credits-info').textContent = `${used} de ${limit} usados`;
                    document.getElementById('current-plan').textContent = plan;
                    document.getElementById('plan-info').textContent = data.plan_price > 0 ? `$${data.plan_price}/mes` : 'Gratis';
                    
                    // Actualizar indicador visual seg√∫n cr√©ditos
                    const creditsDisplay = document.getElementById('credits-remaining');
                    if (remaining === 0) {
                        creditsDisplay.style.color = '#ef4444';
                        document.getElementById('analyze-btn').disabled = true;
                        document.getElementById('analyze-btn').innerHTML = '<i class="fas fa-lock"></i> Sin Cr√©ditos';
                        showAlert('warning', '‚ö† Cr√©ditos agotados. Actualiza a PRO para an√°lisis ilimitados.', 'analysis-alert');
                    } else if (remaining <= 2 && plan === 'Free') {
                        creditsDisplay.style.color = '#f59e0b';
                        showAlert('info', `‚Ñπ Te quedan ${remaining} an√°lisis. Considera actualizar a PRO.`, 'analysis-alert');
                    } else {
                        creditsDisplay.style.color = '#10b981';
                    }
                } else {
                    console.error('Error al verificar cr√©ditos:', data);
                    showAlert('error', 'No se pudieron cargar tus cr√©ditos. Recarga la p√°gina.', 'analysis-alert');
                }
            } catch (error) {
                console.error('Excepci√≥n al cargar cr√©ditos:', error);
                showAlert('error', 'Error de conexi√≥n al cargar datos', 'analysis-alert');
            }
        }
        
        async function performAnalysis(event) {
            event.preventDefault();
            
            const analysisType = document.getElementById('analysis-type').value;
            const fileName = document.getElementById('file-name').value;
            const url = document.getElementById('url-input').value;
            
            const formData = new FormData();
            formData.append('action', 'analyze');
            formData.append('email', userEmail);
            formData.append('analysis_type', analysisType);
            
            if (analysisType === 'url') {
                formData.append('url', url);
            } else {
                formData.append('file_name', fileName);
                formData.append('file_hash', 'sha256_' + Math.random().toString(36).substr(2, 9));
            }
            
            document.getElementById('analyze-btn').disabled = true;
            document.getElementById('analyze-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando...';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                console.log('Resultado del an√°lisis:', data);
                
                if (data.success) {
                    showAlert('success', '‚úì An√°lisis completado exitosamente', 'analysis-alert');
                    displayResult(data.result);
                    // Actualizar UI inmediatamente
                    await checkCredits();
                    await loadHistory();
                    await loadStats();
                    // Scroll suave a resultados
                    document.getElementById('result-box').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    showAlert('error', data.message || 'Error desconocido al realizar el an√°lisis', 'analysis-alert');
                    if (data.upgrade_required) {
                        // Mostrar modal de upgrade en lugar de redirecci√≥n abrupta
                        const confirmed = confirm(data.message + '\n\n¬øDeseas ver los planes disponibles?');
                        if (confirmed) {
                            window.location.href = 'jorise-pricing.html?email=' + encodeURIComponent(userEmail);
                        }
                    }
                }
            } catch (error) {
                console.error('Error en an√°lisis:', error);
                showAlert('error', 'Error de conexi√≥n con el servidor. Por favor verifica tu conexi√≥n a internet e intenta nuevamente.', 'analysis-alert');
            } finally {
                document.getElementById('analyze-btn').disabled = false;
                document.getElementById('analyze-btn').innerHTML = '<i class="fas fa-shield-alt"></i> Analizar Ahora';
            }
        }
        
        function displayResult(result) {
            const resultBox = document.getElementById('result-box');
            const resultContent = document.getElementById('result-content');
            
            const threatClass = result.verdict || result.threat_level || 'unknown';
            const threatScore = result.threat_score || result.score || 0;
            
            const threatText = {
                'clean': '‚úì Seguro',
                'potentially_unwanted': '‚ö† Potencialmente no deseado',
                'suspicious': '‚ö† Sospechoso',
                'malicious': '‚úó Malicioso',
                'unknown': '? Desconocido'
            };
            
            const threatColors = {
                'clean': '#10b981',
                'potentially_unwanted': '#f59e0b',
                'suspicious': '#f59e0b',
                'malicious': '#ef4444',
                'unknown': '#6b7280'
            };
            
            const target = result.target || result.url || result.file_name || 'N/A';
            const analysisType = result.analysis_type || result.type || 'unknown';
            
            resultContent.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px 10px 0 0; color: white;">
                    <h3 style="margin: 0; font-size: 1.3em;">üìä Resultado del An√°lisis</h3>
                </div>
                
                <div style="padding: 20px; background: white; border-radius: 0 0 10px 10px;">
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-left: 4px solid ${threatColors[threatClass]}; border-radius: 5px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: #1e293b; font-size: 1.1em;">Veredicto:</strong>
                            <span style="background: ${threatColors[threatClass]}; color: white; padding: 5px 15px; border-radius: 20px; font-weight: 600;">
                                ${threatText[threatClass]}
                            </span>
                        </div>
                        <div style="color: #64748b; font-size: 0.9em;">
                            <strong>Objetivo:</strong> ${target}<br>
                            <strong>Tipo:</strong> ${analysisType === 'url' ? 'URL' : 'Archivo'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: #1e293b;">Puntuaci√≥n de Amenaza</strong>
                            <span style="color: ${threatColors[threatClass]}; font-weight: 700; font-size: 1.2em;">${threatScore}/100</span>
                        </div>
                        <div style="background: #e2e8f0; height: 10px; border-radius: 10px; overflow: hidden;">
                            <div style="background: ${threatColors[threatClass]}; height: 100%; width: ${threatScore}%; transition: width 1s ease;"></div>
                        </div>
                    </div>
                    
                    ${result.recommendations && result.recommendations.length > 0 ? `
                    <div style="margin-top: 20px; padding: 15px; background: #eff6ff; border-radius: 8px;">
                        <strong style="color: #1e40af; display: block; margin-bottom: 10px;">üí° Recomendaciones:</strong>
                        <ul style="margin: 0; padding-left: 20px; color: #1e293b;">
                            ${result.recommendations.map(r => `<li style="margin-bottom: 5px;">${r}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${result.ai_report ? `
                    <div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border-radius: 8px; border: 1px solid #86efac;">
                        <strong style="color: #16a34a; display: block; margin-bottom: 10px;">ü§ñ An√°lisis con IA:</strong>
                        <div style="color: #1e293b; white-space: pre-line;">${result.ai_report}</div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            resultBox.style.display = 'block';
        }
        
        async function loadHistory() {
            const container = document.getElementById('history-container');
            
            try {
                const response = await fetch(`${API_URL}?action=get_history&email=${encodeURIComponent(userEmail)}&limit=10`);
                const data = await response.json();
                
                if (data.success && data.history.length > 0) {
                    container.innerHTML = data.history.map(item => `
                        <div class="history-item">
                            <div class="history-info">
                                <h4>${item.file_name || item.url || 'An√°lisis de red'}</h4>
                                <p>${new Date(item.created_at).toLocaleString('es-ES')} - ${item.analysis_type}</p>
                            </div>
                            <span class="threat-badge ${item.threat_level}">${item.threat_level}</span>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No hay an√°lisis previos</p>';
                }
            } catch (error) {
                container.innerHTML = '<p style="text-align: center; color: #f56565; padding: 20px;">Error al cargar historial</p>';
            }
        }
        
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}?action=get_stats&email=${encodeURIComponent(userEmail)}`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('total-analyses').textContent = stats.total_analyses || 0;
                    document.getElementById('threats-found').textContent = (stats.suspicious || 0) + (stats.malicious || 0);
                    
                    // Renderizar gr√°ficos
                    renderThreatChart(stats);
                    renderAnalysisChart(stats);
                }
            } catch (error) {
                console.error('Error al cargar estad√≠sticas:', error);
            }
        }
        
        // Gr√°fico de Pastel - Distribuci√≥n de Amenazas
        let threatChart = null;
        function renderThreatChart(stats) {
            const ctx = document.getElementById('threatChart');
            if (!ctx) return;
            
            const clean = stats.clean || 0;
            const suspicious = stats.suspicious || 0;
            const malicious = stats.malicious || 0;
            
            if (threatChart) {
                threatChart.destroy();
            }
            
            threatChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Limpio', 'Sospechoso', 'Malicioso'],
                    datasets: [{
                        data: [clean, suspicious, malicious],
                        backgroundColor: [
                            '#10b981',  // Verde
                            '#f59e0b',  // Naranja
                            '#ef4444'   // Rojo
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 13 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = clean + suspicious + malicious;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Gr√°fico de Barras - An√°lisis Recientes
        let analysisChart = null;
        async function renderAnalysisChart(stats) {
            const ctx = document.getElementById('analysisChart');
            if (!ctx) return;
            
            try {
                // Obtener historial para timeline
                const response = await fetch(`${API_URL}?action=get_history&email=${encodeURIComponent(userEmail)}&limit=20`);
                const data = await response.json();
                
                if (!data.success || !data.history || data.history.length === 0) {
                    // Mostrar datos por defecto si no hay historial
                    renderDefaultAnalysisChart(ctx, stats);
                    return;
                }
                
                // Agrupar por fecha (√∫ltimos 7 d√≠as)
                const last7Days = {};
                const today = new Date();
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    last7Days[dateStr] = { clean: 0, suspicious: 0, malicious: 0 };
                }
                
                // Contar an√°lisis por d√≠a
                data.history.forEach(item => {
                    const dateStr = item.created_at.split(' ')[0];
                    if (last7Days[dateStr]) {
                        const level = item.threat_level || 'clean';
                        if (level === 'low' || level === 'clean') {
                            last7Days[dateStr].clean++;
                        } else if (level === 'medium' || level === 'high' || level === 'suspicious') {
                            last7Days[dateStr].suspicious++;
                        } else if (level === 'critical' || level === 'malicious') {
                            last7Days[dateStr].malicious++;
                        }
                    }
                });
                
                const labels = Object.keys(last7Days).map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
                });
                
                const cleanData = Object.values(last7Days).map(d => d.clean);
                const suspiciousData = Object.values(last7Days).map(d => d.suspicious);
                const maliciousData = Object.values(last7Days).map(d => d.malicious);
                
                if (analysisChart) {
                    analysisChart.destroy();
                }
                
                analysisChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Limpio',
                                data: cleanData,
                                backgroundColor: '#10b981',
                                borderRadius: 5
                            },
                            {
                                label: 'Sospechoso',
                                data: suspiciousData,
                                backgroundColor: '#f59e0b',
                                borderRadius: 5
                            },
                            {
                                label: 'Malicioso',
                                data: maliciousData,
                                backgroundColor: '#ef4444',
                                borderRadius: 5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            x: {
                                stacked: true,
                                grid: { display: false }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 13 }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error al cargar datos del gr√°fico:', error);
                renderDefaultAnalysisChart(ctx, stats);
            }
        }
        
        function renderDefaultAnalysisChart(ctx, stats) {
            if (analysisChart) {
                analysisChart.destroy();
            }
            
            analysisChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Total'],
                    datasets: [
                        {
                            label: 'Limpio',
                            data: [stats.clean || 0],
                            backgroundColor: '#10b981',
                            borderRadius: 5
                        },
                        {
                            label: 'Sospechoso',
                            data: [stats.suspicious || 0],
                            backgroundColor: '#f59e0b',
                            borderRadius: 5
                        },
                        {
                            label: 'Malicioso',
                            data: [stats.malicious || 0],
                            backgroundColor: '#ef4444',
                            borderRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 13 } }
                        }
                    }
                }
            });
        }
        
        function showAlert(type, message, elementId) {
            const alert = document.getElementById(elementId);
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        function logout() {
            localStorage.removeItem('jorise_user_email');
            window.location.href = 'jorise-pricing.html';
        }
        
        // Cargar dashboard
        loadDashboard();
    </script>
</body>
</html>
